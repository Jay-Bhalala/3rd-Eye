"use strict";var ThirdEye=(()=>{var I=Object.defineProperty;var V=Object.getOwnPropertyDescriptor;var X=Object.getOwnPropertyNames;var Y=Object.prototype.hasOwnProperty;var Q=(e,n)=>{for(var t in n)I(e,t,{get:n[t],enumerable:!0})},Z=(e,n,t,o)=>{if(n&&typeof n=="object"||typeof n=="function")for(let r of X(n))!Y.call(e,r)&&r!==t&&I(e,r,{get:()=>n[r],enumerable:!(o=V(n,r))||o.enumerable});return e};var ee=e=>Z(I({},"__esModule",{value:!0}),e);var $e={};Q($e,{ThirdEyeSDK:()=>L,default:()=>Ie,destroy:()=>we,getConfig:()=>xe,getScannedElements:()=>Ae,getSchemas:()=>Le,init:()=>Ee,isInitialized:()=>Ce,isWatcherActive:()=>Oe,scan:()=>be});var $="[3rdEye]",P=!1;function k(e){P=e}function a(...e){P&&console.log($,...e)}function l(...e){console.warn($,...e)}function f(...e){console.error($,...e)}var te="https://api.3rdeye.dev/api/v1/telemetry",R="",M=te;function _(e,n){R=e,n&&(M=n)}function u(e,n){try{let t={event:e,siteId:R,timestamp:new Date().toISOString(),userAgent:navigator.userAgent,data:n},o=JSON.stringify(t);if(navigator.sendBeacon){let r=new Blob([o],{type:"application/json"});navigator.sendBeacon(M,r)}else fetch(M,{method:"POST",headers:{"Content-Type":"application/json"},body:o,keepalive:!0}).catch(()=>{});a(`\u{1F4E1} Telemetry \u2192 ${e}`,n??"")}catch{l("Telemetry delivery failed for event:",e)}}function S(e){if(e.id)return`#${e.id}`;let n=e.tagName.toLowerCase(),t=e.parentElement;if(!t)return n;let o=Array.from(t.children).filter(i=>i.tagName===e.tagName);if(o.length===1)return`${S(t)} > ${n}`;let r=o.indexOf(e)+1;return`${S(t)} > ${n}:nth-of-type(${r})`}function ne(e){if(e.id){let t=document.querySelector(`label[for="${e.id}"]`);if(t)return t.textContent?.trim()}let n=e.closest("label");if(n)return n.textContent?.trim()}var oe='form, button, [role="button"], input[type="button"], input[type="submit"]';function N(e){return e.hasAttribute("data-tool-ignore")}function H(e){let n=e.getAttribute("data-tool-name")??void 0,t=e.getAttribute("data-tool-description")??void 0,o=e.hasAttribute("data-tool-readonly"),r=e.hasAttribute("data-tool-destructive"),i=e.hasAttribute("data-tool-idempotent"),s=e.hasAttribute("data-tool-open-world"),d;return(o||r||i||s)&&(d={},o&&(d.readOnlyHint=!0),r&&(d.destructiveHint=!0),i&&(d.idempotentHint=!0),s&&(d.openWorldHint=!0)),{overrideName:n,overrideDescription:t,overrideAnnotations:d}}function re(){let e=document.querySelectorAll("form"),n=[];return e.forEach(t=>{if(N(t))return;let o=H(t),r=t.querySelectorAll("input, select, textarea"),i=[];r.forEach(s=>{if(s instanceof HTMLInputElement&&["hidden","submit","button","reset","image"].includes(s.type))return;let d=s.name||s.id||"";if(!d)return;let m=s.getAttribute("data-tool-param")??void 0;i.push({name:d,inputType:s instanceof HTMLInputElement?s.type:s.tagName.toLowerCase(),required:s.required,placeholder:s instanceof HTMLInputElement&&s.placeholder||void 0,label:ne(s),overrideParamDescription:m})}),n.push({type:"form",id:t.id||void 0,selector:S(t),action:t.action||void 0,method:(t.method||"GET").toUpperCase(),inputs:i,...o})}),n}function ie(){let e=document.querySelectorAll('button, [role="button"], input[type="button"], input[type="submit"]'),n=[];return e.forEach(t=>{if(N(t))return;let o=H(t),r=t.getAttribute("aria-label")??void 0,i=t.textContent?.trim()||void 0,s=t.id||void 0;!o.overrideName&&!r&&!s&&!i||t.closest("form")||n.push({type:"button",id:s,selector:S(t),ariaLabel:r,textContent:i,...o})}),n}function ae(){let e=document.querySelectorAll("[data-tool-name]"),n=[];return e.forEach(t=>{if(N(t)||t.matches(oe)||t.closest("form"))return;let o=H(t),r=t.getAttribute("aria-label")??void 0,i=t.textContent?.trim()||void 0,s=t.id||void 0;n.push({type:"button",id:s,selector:S(t),ariaLabel:r,textContent:i,...o})}),n}function y(){let e=re(),n=ie(),t=ae(),o=[...e,...n,...t];return a(`\u{1F50D} Scanner found ${e.length} form(s), ${n.length} button(s), and ${t.length} annotated element(s)`,o),o}function q(e){return e.toLowerCase().replace(/[^a-z0-9]+/g,"_").replace(/^_|_$/g,"")}function se(e){let n={},t=[];if(e.inputs)for(let o of e.inputs)n[o.name]={type:o.inputType==="number"?"number":"string",description:o.overrideParamDescription||o.label||o.placeholder||`The ${o.name} field (${o.inputType})`},o.required&&t.push(o.name);return{type:"object",properties:n,required:t}}function ce(e){let n=(e??"GET").toUpperCase();return n==="GET"?{readOnlyHint:!0,destructiveHint:!1}:n==="DELETE"?{destructiveHint:!0,readOnlyHint:!1}:{readOnlyHint:!1,openWorldHint:!0}}function le(e){let n=e.overrideName??q(e.id||"unknown_form"),t=e.inputs?.length??0,o=e.overrideDescription??`Submit the "${e.id||"unknown"}" form (${e.method??"GET"}, ${t} field${t!==1?"s":""})`,r=e.overrideAnnotations??ce(e.method);return{name:n,description:o,parameters:se(e),selector:e.selector,elementType:"form",annotations:r}}function de(e){let n=(e.ariaLabel||e.textContent||"").toLowerCase(),t=["delete","remove","cancel","destroy","unsubscribe"],o=["search","view","show","filter","browse","find"];return t.some(r=>n.includes(r))?{destructiveHint:!0,readOnlyHint:!1}:o.some(r=>n.includes(r))?{readOnlyHint:!0,destructiveHint:!1}:{idempotentHint:!0}}function ue(e){let n=e.ariaLabel||e.textContent||e.id||"unknown_button",t=e.overrideName??q(n),o=e.overrideDescription??`Click the "${n}" button`,r=e.overrideAnnotations??de(e);return{name:t,description:o,parameters:{type:"object",properties:{},required:[]},selector:e.selector,elementType:"button",annotations:r}}function U(e){let n=[];for(let t of e)t.type==="form"?n.push(le(t)):t.type==="button"&&n.push(ue(t));return n}var W="__3rdeye_schemas_",me=300*1e3;function fe(){try{if(typeof localStorage>"u")return null;let e=W+window.location.pathname,n=localStorage.getItem(e);if(!n)return null;let t=JSON.parse(n);return Date.now()-t.timestamp>me?(localStorage.removeItem(e),null):(a("\u{1F4E6} Using cached schemas"),t.schemas)}catch{return null}}function ge(e){try{if(typeof localStorage>"u")return;let n=W+window.location.pathname;localStorage.setItem(n,JSON.stringify({schemas:e,timestamp:Date.now()}))}catch{}}async function E(e,n,t=!1){if(!t){let i=fe();if(i)return i}if(e.every(i=>i.overrideName&&i.overrideDescription)){let i=U(e);return a(`\u{1F9E0} All ${i.length} element(s) have declarative overrides \u2014 skipping API`,i),i}if(n)try{let i=new AbortController,s=setTimeout(()=>i.abort(),15e3),d=typeof window<"u"?window.location.href:"unknown";a(`\u{1F9E0} Requesting AI schemas from ${n}...`);let m=await fetch(`${n}/api/v1/generate-schema`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pageUrl:d,elements:e}),signal:i.signal});if(clearTimeout(s),m.ok){let O=await m.json(),T=O.schemas??[];if(T.length>0){let J=O.meta?.source??"unknown";return a(`\u{1F9E0} Received ${T.length} schema(s) from API (source: ${J})`,T),ge(T),T}}l(`API returned ${m.status}, falling back to local.`)}catch(i){i instanceof DOMException&&i.name==="AbortError"?l("API request timed out (15s), falling back to local."):l("API unreachable, falling back to local.")}let r=U(e);return a(`\u{1F9E0} Generated ${r.length} schema(s) locally (fallback)`,r),r}var g=new Map;function F(){return new Set(g.keys())}function pe(e,n){for(let[t,o]of Object.entries(n)){let r=e.querySelector(`[name="${t}"], #${CSS.escape(t)}`);if(!r){l(`Input "${t}" not found in form "${e.id}". Skipping.`);continue}let i=Object.getOwnPropertyDescriptor(window.HTMLInputElement.prototype,"value")?.set??Object.getOwnPropertyDescriptor(window.HTMLTextAreaElement.prototype,"value")?.set;i?i.call(r,o):r.value=o,r.dispatchEvent(new Event("input",{bubbles:!0})),r.dispatchEvent(new Event("change",{bubbles:!0}))}typeof e.requestSubmit=="function"?e.requestSubmit():e.submit()}function he(e){e.click()}async function ve(e,n){if(!e.annotations?.destructiveHint)return!0;if(!n?.requestUserInteraction)return l(`\u26A0\uFE0F Tool "${e.name}" is destructive but client doesn't support confirmation.`),!0;try{let o=await n.requestUserInteraction(async()=>window.confirm(`AI agent wants to perform: "${e.description}"

This action may modify or delete data. Allow?`))===!0;return u("USER_CONFIRMATION",{toolName:e.name,allowed:o,destructive:!0}),o||a(`\u{1F6AB} User denied execution of destructive tool "${e.name}".`),o}catch(t){return l(`requestUserInteraction failed for "${e.name}":`,t),!0}}function b(e){if(!navigator.modelContext){l("Cannot register tools \u2014 navigator.modelContext is unavailable.");return}let n=0;for(let t of e){if(g.has(t.name)){a(`Tool "${t.name}" already registered. Skipping.`);continue}try{navigator.modelContext.registerTool({name:t.name,description:t.description,inputSchema:t.parameters,annotations:t.annotations,execute:async(o,r)=>{let i=Date.now();u("TOOL_ATTEMPT",{toolName:t.name,args:o});try{if(!await ve(t,r))return{success:!1,toolName:t.name,reason:"User denied destructive action."};let d=document.querySelector(t.selector);if(!d)throw new Error(`Element not found for selector: ${t.selector}`);t.elementType==="form"?pe(d,o):he(d);let m=Date.now()-i;return u("TOOL_SUCCESS",{toolName:t.name,duration:m}),a(`\u2705 Tool "${t.name}" executed in ${m}ms`),{success:!0,toolName:t.name,duration:m}}catch(s){let d=Date.now()-i,m=s instanceof Error?s.message:"Unknown error";throw u("TOOL_ERROR",{toolName:t.name,error:m,duration:d}),f(`Tool "${t.name}" failed:`,m),s}}}),g.set(t.name,t.selector),u("TOOL_REGISTERED",{toolName:t.name}),n++}catch(o){f(`Failed to register tool "${t.name}":`,o)}}a(`\u{1F680} Registered ${n}/${e.length} tool(s) with WebMCP`)}function z(e){if(!navigator.modelContext)return;let n=new Set(e);for(let[t,o]of g)if(n.has(o))try{navigator.modelContext.unregisterTool(t),g.delete(t),u("TOOL_UNREGISTERED",{toolName:t,selector:o}),a(`\u{1F5D1}\uFE0F Unregistered stale tool "${t}" (element removed)`)}catch(r){f(`Failed to unregister tool "${t}":`,r)}}function j(){if(!navigator.modelContext)return;for(let[n]of g)try{navigator.modelContext.unregisterTool(n)}catch{}let e=g.size;g.clear(),a(`\u{1F5D1}\uFE0F Unregistered all ${e} tool(s)`)}var p=null,v=null,C=new Set,w="",x=null,Te=300;function Se(e){let n=new Set(e.map(r=>r.selector)),t=e.filter(r=>!C.has(r.selector)),o=[...C].filter(r=>!n.has(r));return{added:t,removedSelectors:o}}async function ye(e){if(x)try{let n=y(),{added:t,removedSelectors:o}=Se(n);if(t.length===0&&o.length===0)return;if(a(`\u{1F504} DOM ${e}: +${t.length} new, -${o.length} removed`),u("DOM_MUTATION",{reason:e,added:t.length,removed:o.length}),o.length>0){let r=F();z(o)}if(t.length>0){let r=await E(t,x.endpoint,!0);b(r)}C=new Set(n.map(r=>r.selector))}catch(n){f("Watcher re-scan failed:",n)}}function G(e){v&&clearTimeout(v),v=setTimeout(()=>ye(e),Te)}function A(){let e=window.location.href;e!==w&&(a(`\u{1F9ED} SPA navigation detected: ${w} \u2192 ${e}`),u("SPA_NAVIGATE",{from:w,to:e}),w=e,G("navigation"))}function B(e,n){if(p){l("Watcher already running.");return}x=e,C=new Set(n),w=window.location.href,p=new MutationObserver(t=>{t.some(r=>r.addedNodes.length>0||r.removedNodes.length>0)&&G("mutation")}),p.observe(document.body,{childList:!0,subtree:!0}),window.addEventListener("popstate",A),window.addEventListener("hashchange",A),a("\u{1F441}\uFE0F Live watcher started (MutationObserver + SPA navigation)")}function K(){p&&(p.disconnect(),p=null),v&&(clearTimeout(v),v=null),window.removeEventListener("popstate",A),window.removeEventListener("hashchange",A),C.clear(),x=null,a("\u{1F441}\uFE0F Live watcher stopped")}function D(){return p!==null}var L=class{config=null;initialized=!1;scannedElements=[];registeredSchemas=[];async init(n){if(this.initialized){l("SDK already initialized.");return}if(!n.siteId){f("Missing required `siteId`. Aborting.");return}this.config=n,this.initialized=!0,k(n.debug??!1),_(n.siteId,n.ingestUrl),a("Initializing with config:",n),u("SDK_INIT",{endpoint:n.endpoint}),navigator.modelContext||l("WebMCP not supported in this browser. Polyfill active.");try{if(this.scannedElements=y(),u("SCAN_COMPLETE",{elementCount:this.scannedElements.length}),this.scannedElements.length===0){a("No actionable elements found. Nothing to register.");return}this.registeredSchemas=await E(this.scannedElements,n.endpoint),b(this.registeredSchemas),this.providePageContext();let t=this.scannedElements.map(o=>o.selector);B(n,t)}catch(t){f("Pipeline error:",t)}}providePageContext(){if(navigator.modelContext?.provideContext)try{let n=document.querySelector('meta[name="description"]');navigator.modelContext.provideContext({tools:[],title:document.title,url:window.location.href,description:n?.content??""}),a("\u{1F4C4} Provided page context to AI agent")}catch(n){l("provideContext not available:",n)}}async scan(){if(!this.initialized||!this.config)return l("Cannot scan \u2014 SDK not initialized. Call init() first."),[];try{this.scannedElements=y(),u("SCAN_COMPLETE",{elementCount:this.scannedElements.length}),this.registeredSchemas=await E(this.scannedElements,this.config.endpoint),b(this.registeredSchemas)}catch(n){f("Re-scan error:",n)}return this.scannedElements}destroy(){if(a("\u{1F480} Destroying SDK..."),D()&&K(),j(),navigator.modelContext?.clearContext)try{navigator.modelContext.clearContext(),a("\u{1F9F9} Cleared page context")}catch{}this.config=null,this.initialized=!1,this.scannedElements=[],this.registeredSchemas=[],a("\u{1F480} SDK destroyed")}isInitialized(){return this.initialized}getConfig(){return this.config}getScannedElements(){return this.scannedElements}getSchemas(){return this.registeredSchemas}isWatcherActive(){return D()}},c=new L,Ee=c.init.bind(c),be=c.scan.bind(c),we=c.destroy.bind(c),Ce=c.isInitialized.bind(c),xe=c.getConfig.bind(c),Ae=c.getScannedElements.bind(c),Le=c.getSchemas.bind(c),Oe=c.isWatcherActive.bind(c),Ie=c;if(typeof document<"u"&&document.currentScript){let e=document.currentScript,n=e.getAttribute("data-site-id");if(n){let t={siteId:n,endpoint:e.getAttribute("data-endpoint")??void 0,ingestUrl:e.getAttribute("data-ingest-url")??void 0,debug:e.getAttribute("data-debug")==="true"};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{c.init(t)}):c.init(t)}}return ee($e);})();
//# sourceMappingURL=3rdeye.min.js.map